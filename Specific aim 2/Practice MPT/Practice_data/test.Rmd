---
title: "Bayesian MPT"
author: "AMS"
date: "1/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this vignette we will try to fit a bayesian MPT model of our eye tracking data matching the structure of the tree below.
```{r, results='hide'}
library(readxl)
library(rstan)
library(tidyverse)
library(data.tree)
```

```{r}
#load data
library(readxl)
Practice_xls <- read_excel("Participant2.xlsx") %>% 
  filter(condition != "practice")

#Wrangle data
df2 = Practice_xls %>%
  rename(aoi1 = RIGHT_IA_1_SAMPLE_COUNT) %>%
  rename(aoi2 = RIGHT_IA_2_SAMPLE_COUNT) %>%
  rename(aoi3 = RIGHT_IA_3_SAMPLE_COUNT) %>%
  rename(aoi4 = RIGHT_IA_4_SAMPLE_COUNT)

#create single column showing what aoi participant was looking at
df2$aoi_all = ifelse(df2$aoi1 > 0, 1,
                     ifelse(df2$aoi2 > 0, 2, 
                            ifelse(df2$aoi3 > 0, 3, 4)))

df2$y_5 = ifelse(df2$aoi_all == df2$unrelated_location, 0, 
                 ifelse(df2$aoi_all == df2$phonemic_location, 1,
                        ifelse(df2$aoi_all == df2$semantic_location, 2,
                               ifelse(df2$aoi_all == df2$target_location, 3, 4)))) 
# yy.list is the hierachical structure of available steps in the tree model. 

library(tidyr)

df2 = df2 %>%
  mutate(y =  na_if(y_5, 4)) %>% 
  fill(y, .direction = "up")

#check to m ake sure we only have 0 through 3
unique(df2$y)

#Create count for each var
df3 = data.frame(Count = df2$y,
                 resp = ifelse(df2$y == 0, "Unrelated",
                               ifelse(df2$y == 1, "Phonological",
                                      ifelse(df2$y == 2, "Semantic", "Correct"))))
df3 %>%
  count(resp)

```

```{r}
#Create tree structure
TreeStructure3= Node$new("(Node 1)Auditory input")
Lex_Phon= Node$new("(Node 2) Anticipated // Phonological Distractor (a)")
TreeStructure3$AddChildNode(Lex_Phon)
Unrelated = TreeStructure3$AddChild("Unrelated (1-a) [y*tji1] ")
Sem = Lex_Phon$AddChild("(Node 3)Anticipated // Semantic distractor (1-b) [y*tji3]")
Lex_Phon$AddChildNode(Sem)
Correct = Lex_Phon$AddChild("Correct (b) [y*tji2]")
Correct = Sem$AddChild("Correct (c) [y*tji4]")
Phon_Dis = Sem$AddChild("Phonologial Distractor 1-c")
SetNodeStyle(TreeStructure3,  shape = "egg", 
             fontname = "helvetica", tooltip = GetDefaultTooltip)
Do(TreeStructure3$leaves, function(node) SetNodeStyle(node, shape = "box"))
plot(TreeStructure3)
```
```{r}
#Create tree structure
TreeStructure3= Node$new("(Node 1)Auditory input")
Unrelated = TreeStructure3$AddChild("Unrelated (1-a) [y*tji1] ")
Lex_Phon= Node$new("(Node 2) Anticipated // Correct Phonological access (a)")
TreeStructure3$AddChildNode(Lex_Phon)
Phon_dis = TreeStructure3$AddChild("Phonological Distractor (1-a) [y*tji1] ")
Sem_access = Lex_Phon$AddChild("(Node 3)Anticipated // Semantic Access (1-b) [y*tji3]")
Lex_Phon$AddChildNode(Sem_access)
Correct = Lex_Phon$AddChild("Correct (b) [y*tji2]")
Phon_check = 
Correct = Sem$AddChild("Correct (c) [y*tji4]")
Phon_Dis = Sem$AddChild("Phonologial Distractor 1-c")
SetNodeStyle(TreeStructure3,  shape = "egg", 
             fontname = "helvetica", tooltip = GetDefaultTooltip)
Do(TreeStructure3$leaves, function(node) SetNodeStyle(node, shape = "box"))
plot(TreeStructure3)
```
Table 1. Psychological Interpretation of parameters in above MPT model

| Parameter      | Description |
| ----------- | ----------- |
| a      |  Probability of phonological competitor        |
| b   | Probability of semantic competitor        |
| c   | Probability of correct response         |

Note that we need to think of the probability in which all outcomes are possible such that

$$(Unrelated|a,b,c) = 1 - a \\
(Phonologial.Distractor|a,b,c) = a  ⋅b⋅ (1-c) \\
(Semantic.Distractor|a,b,c) = a⋅(1-b) \\
(Correct|a,b,c) = a⋅b+a⋅(1-b) ⋅c
  \\ $$
  

The above code is defined similarly:

$$\theta_u = 1 - a \\
\theta_p = a  ⋅b +a⋅b (1-c)\\
\theta_s = a⋅(1-b) \\
\theta_c = a⋅b+a⋅(1-b) ⋅c\\
\theta = (theta_u, theta_p, theta_s, theta_c) \\
gaze \sim (\theta) \\
a,b,c \sim \beta eta

$$

# Create Rstan model from above probability distribution and parameter estimates
```{r}
mpt_simp = "
data { 
  int<lower = 1> N_trials;
  int<lower = 0, upper = N_trials> resp[4];
}
parameters {
  real<lower = 0, upper = 1> a;
  real<lower = 0, upper = 1> b;
  real<lower = 0, upper = 1> c;
} 
transformed parameters {
  simplex[4] theta;
  theta[1] = 1 - a; //Pr_unrel
  theta[2] = a + a * b * (1-c); //Pr_phon
  theta[3] = a * (1-b);  //S
  theta[4] = a * (b) + a  * (1-b) * c; //Pr_correct
}
model {
  target += beta_lpdf(a | 2, 2);
  target += beta_lpdf(b | 2, 2);
  target += beta_lpdf(c | 2, 2);
  target += multinomial_lpmf(resp | theta);
}
generated quantities{
    int pred_resp[5];
    pred_resp = multinomial_rng(theta, 5);
}"

```


#Run model

```{r}
N_trials = 5309
resp = as.integer(c(1211, 1423, 1258, 1417))

#data for model
data_sMPT = list(N_trials = as.integer(N_trials),
                 resp = as.integer(c(1211, 1423, 1258, 1417)))


fit_sMPT = stan(
  model_code = mpt_simp,  # Stan program
  data = data_sMPT,    # named list ofdata
  chains = 1,             # number of Markov chains
  warmup = 1000,          # number of warmup iterations per chain
  iter = 2000,            # total number of iterations per chain
  cores = 1,              # number of cores (could use one per chain)
  )
```

